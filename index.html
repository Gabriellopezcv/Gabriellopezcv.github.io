<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas del Conflicto en Palestina (Oct 2023 - Presente)</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
        }
        .card-title {
            color: #bb86fc;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #f8f9fa;
        }
        .table {
            --bs-table-bg: #1e1e1e;
            --bs-table-striped-bg: #2c2c2c;
            --bs-table-color: #e0e0e0;
            --bs-table-border-color: #333;
        }
        h1, h2 {
            color: #bb86fc;
            border-bottom: 2px solid #3700b3;
            padding-bottom: 10px;
        }
        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
        .source-link {
            color: #03dac6;
            text-decoration: none;
        }
        .source-link:hover {
            color: #ffffff;
            text-decoration: underline;
        }
        #error-message {
            background-color: #3e1a1a;
            color: #ffcdd2;
            border: 1px solid #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <header class="text-center mb-5">
            <h1>Estadísticas del Conflicto en Palestina</h1>
            <p class="lead">Datos actualizados desde el 7 de Octubre de 2023. La información se obtiene automáticamente del repositorio <a href="https://github.com/TechForPalestine/palestine-datasets" target="_blank" class="source-link">TechForPalestine/palestine-datasets</a>.</p>
        </header>

        <div id="loader" class="text-center">
            <div class="spinner-border text-primary loading-spinner" role="status">
                <span class="visually-hidden">Cargando datos...</span>
            </div>
            <p class="mt-2">Cargando datos, por favor espera...</p>
        </div>
        <div id="error-message" class="alert d-none" role="alert"></div>

        <section id="main-content" class="d-none">
            <!-- Sección de Resumen -->
            <section id="summary-section" class="mb-5">
                <h2 class="mb-4">Resumen Total</h2>
                <div id="summary-cards" class="row">
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Total de Víctimas (Gaza + Cisj.)</h5>
                                <p id="total-martyrs" class="stat-number mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Víctimas en Gaza</h5>
                                <p id="gaza-martyrs" class="stat-number mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Víctimas en Cisjordania</h5>
                                <p id="wb-martyrs" class="stat-number mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Total de Heridos (Gaza)</h5>
                                <p id="total-injured" class="stat-number mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Niños/as Asesinados (Gaza)</h5>
                                <p id="children-martyrs" class="stat-number mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Mujeres Asesinadas (Gaza)</h5>
                                <p id="women-martyrs" class="stat-number mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-6 mb-4">
                        <div class="card text-center h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Última actualización de datos</h5>
                                <p id="last-update" class="stat-number mb-0" style="font-size: 1.8rem;">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sección de Gráficos -->
            <section id="charts-section" class="mb-5">
                <h2 class="mb-4">Visualización de Datos</h2>
                <div class="row">
                    <div class="col-lg-12 mb-4"><div class="card"><div class="card-body"><canvas id="dailyDeathsChart"></canvas></div></div></div>
                    <div class="col-lg-12 mb-4"><div class="card"><div class="card-body"><canvas id="cumulativeDeathsChart"></canvas></div></div></div>
                </div>
            </section>

            <!-- Sección de Tabla de Datos -->
            <section id="table-section" class="mb-5">
                <h2 class="mb-4">Datos Diarios Detallados (Gaza)</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Nuevas Víctimas</th>
                                <th>Total Acumulado</th>
                                <th>Nuevos Heridos</th>
                                <th>Total Heridos</th>
                                <th>Nuevos Niños</th>
                                <th>Total Niños</th>
                                <th>Nuevas Mujeres</th>
                                <th>Total Mujeres</th>
                            </tr>
                        </thead>
                        <tbody id="gaza-table-body"></tbody>
                    </table>
                </div>
            </section>
        </section>
        
        <footer class="text-center mt-5">
            <p><small>Página creada con fines informativos. Los datos son propiedad de sus autores.</small></p>
        </footer>
    </div>

    <!-- Librerías de JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // **CAMBIO IMPORTANTE: Usamos jsDelivr, una CDN fiable para GitHub.**
            const gazaURL = 'https://cdn.jsdelivr.net/gh/TechForPalestine/palestine-datasets@main/data/gaza_daily_martyrs_2023_2024.csv';
            const westBankURL = 'https://cdn.jsdelivr.net/gh/TechForPalestine/palestine-datasets@main/data/west_bank_daily_martyrs_2023_2024.csv';

            async function fetchData() {
                try {
                    const [gazaResponse, wbResponse] = await Promise.all([ fetch(gazaURL), fetch(westBankURL) ]);
                    if (!gazaResponse.ok || !wbResponse.ok) throw new Error(`Error de red. Estatus: ${gazaResponse.status}, ${wbResponse.status}`);

                    const gazaText = await gazaResponse.text();
                    const wbText = await wbResponse.text();
                    
                    const gazaData = Papa.parse(gazaText, { header: true, dynamicTyping: true, skipEmptyLines: true }).data;
                    const wbData = Papa.parse(wbText, { header: true, dynamicTyping: true, skipEmptyLines: true }).data;
                    
                    const cleanGaza = gazaData.filter(r => r && r.date && r.cumulative_martyrs != null);
                    const cleanWb = wbData.filter(r => r && r.date && r.cumulative_martyrs != null);

                    if (cleanGaza.length === 0 || cleanWb.length === 0) throw new Error("No se pudieron procesar los datos CSV. El formato podría haber cambiado o estar vacío.");

                    displayData(cleanGaza, cleanWb);

                } catch (error) {
                    console.error("Error detallado:", error);
                    const loader = document.getElementById('loader');
                    const errorMessage = document.getElementById('error-message');
                    loader.classList.add('d-none');
                    errorMessage.textContent = `Error al cargar los datos: ${error.message}. Por favor, recarga la página. Si el problema persiste, la fuente de datos puede estar temporalmente caída.`;
                    errorMessage.classList.remove('d-none');
                }
            }
            
            function displayData(gazaData, wbData) {
                updateSummaryCards(gazaData, wbData);
                createCharts(gazaData, wbData);
                populateTable(gazaData);
                
                document.getElementById('loader').classList.add('d-none');
                document.getElementById('main-content').classList.remove('d-none');
            }

            function formatNumber(num) {
                return (num === null || num === undefined) ? 'N/A' : num.toLocaleString('es-ES');
            }

            function updateSummaryCards(gazaData, wbData) {
                const latestGaza = gazaData[gazaData.length - 1] || {};
                const latestWb = wbData[wbData.length - 1] || {};
                const gazaMartyrs = latestGaza.cumulative_martyrs || 0;
                const wbMartyrs = latestWb.cumulative_martyrs || 0;
                
                document.getElementById('total-martyrs').textContent = formatNumber(gazaMartyrs + wbMartyrs);
                document.getElementById('gaza-martyrs').textContent = formatNumber(gazaMartyrs);
                document.getElementById('wb-martyrs').textContent = formatNumber(wbMartyrs);
                document.getElementById('total-injured').textContent = formatNumber(latestGaza.cumulative_injured);
                document.getElementById('children-martyrs').textContent = formatNumber(latestGaza.cumulative_children_martyrs);
                document.getElementById('women-martyrs').textContent = formatNumber(latestGaza.cumulative_women_martyrs);
                document.getElementById('last-update').textContent = latestGaza.date || 'Desconocida';
            }
            
            function createCharts(gazaData, wbData) {
                const labels = gazaData.map(row => row.date);
                const gazaDaily = gazaData.map(row => row.daily_martyrs || 0);
                const gazaCumulative = gazaData.map(row => row.cumulative_martyrs || 0);
                const wbDataMap = new Map(wbData.map(row => [row.date, row]));
                const wbCumulative = labels.map(date => {
                    let lastVal = 0;
                    return wbData.find(d => d.date === date)?.cumulative_martyrs || lastVal;
                });
                const wbDaily = labels.map(date => wbDataMap.get(date)?.daily_martyrs || 0);

                const chartOptions = {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#e0e0e0' }}, title: { display: true, color: '#e0e0e0', font: { size: 16 }}},
                    scales: { x: { ticks: { color: '#e0e0e0' }, grid: { color: '#444' }}, y: { ticks: { color: '#e0e0e0' }, grid: { color: '#444' }, beginAtZero: true }}
                };

                new Chart('dailyDeathsChart', { type: 'bar',
                    data: { labels, datasets: [ { label: 'Víctimas Diarias Gaza', data: gazaDaily, backgroundColor: 'rgba(255, 99, 132, 0.7)' }, { label: 'Víctimas Diarias Cisjordania', data: wbDaily, backgroundColor: 'rgba(54, 162, 235, 0.7)' } ]},
                    options: { ...chartOptions, plugins: { ...chartOptions.plugins, title: { ...chartOptions.plugins.title, text: 'Víctimas Diarias (Gaza y Cisjordania)' }}, scales: { ...chartOptions.scales, x: { stacked: true }, y: { stacked: true } } }
                });

                new Chart('cumulativeDeathsChart', { type: 'line',
                    data: { labels, datasets: [ { label: 'Total Víctimas Gaza', data: gazaCumulative, borderColor: '#e91e63', backgroundColor: '#e91e6320', fill: true, tension: 0.1 }, { label: 'Total Víctimas Cisjordania', data: wbCumulative, borderColor: '#2196f3', backgroundColor: '#2196f320', fill: true, tension: 0.1 } ]},
                    options: { ...chartOptions, plugins: { ...chartOptions.plugins, title: { ...chartOptions.plugins.title, text: 'Evolución de Víctimas Acumuladas' }}}
                });
            }
            
            function populateTable(gazaData) {
                const tableBody = document.getElementById('gaza-table-body');
                tableBody.innerHTML = '';
                [...gazaData].reverse().forEach(row => {
                    tableBody.innerHTML += `<tr>
                        <td>${row.date || 'N/A'}</td>
                        <td>${formatNumber(row.daily_martyrs)}</td><td>${formatNumber(row.cumulative_martyrs)}</td>
                        <td>${formatNumber(row.daily_injured)}</td><td>${formatNumber(row.cumulative_injured)}</td>
                        <td>${formatNumber(row.daily_children_martyrs)}</td><td>${formatNumber(row.cumulative_children_martyrs)}</td>
                        <td>${formatNumber(row.daily_women_martyrs)}</td><td>${formatNumber(row.cumulative_women_martyrs)}</td>
                    </tr>`;
                });
            }
            
            fetchData();
        });
    </script>
</body>
</html>